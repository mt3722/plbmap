<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>臺灣念佛會據點互動地圖</title>

  <!-- D3 (Cloudflare CDN) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.9.0/d3.min.js"
          integrity="sha512-u6sqRTuR0lLH9xpDNlbidcF3xhtwHOofPV5ChtcgG+y1lQagtAfqaeJ7X1YfDcoK2EK7gZ0O7sfsK5sdqUJ9/Q=="
          crossorigin="anonymous" referrerpolicy="no-referrer"></script>

  <style>
    /* ---------- 1. 全域 ---------- */
    html, body {
      margin: 0;
      height: 100%;
      font-family: -apple-system, BlinkMacSystemFont,
        "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      background: #1d1f21;
      color: #eaeaea;
    }
    #wrap {
      display: flex;
      height: 100%;
    }

    /* ---------- 2. 左：地圖區 ---------- */
    #mapBox {
      flex: 3;
      min-width: 420px;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    #mapTitle {
      color: #8ab4f8;
      text-align: center;
      margin: .75rem 0 .25rem;
      font-size: 1.6rem;
    }
    #mapTitle small {
      font-size: 0.8rem;
      margin-left: 0.5rem;
      color: #aaa;
    }
    #mapArea {
      flex: 1;
      position: relative;
    }
    svg {
      width: 100%;
      height: 100%;
    }
    .county {
      stroke: #000;
      stroke-width: .6;
      cursor: pointer;
      transition: fill .15s;
    }
    .defaultFill {
      fill: #444;
    }
    .hasBranch {
      fill: #50bf7f;
    }
    .county:hover {
      fill: #f5a623;
    }
    .active {
      fill: #d0021b !important;
    }

    /* ---------- 3. 右：資訊區 ---------- */
    #sideBox {
      flex: 2;
      min-width: 300px;
      max-width: 420px;
      background: #2d2f31;
      border-left: 1px solid #444;
      overflow-y: auto;
      padding: 1.25rem;
      box-sizing: border-box;
    }
    h2 {
      margin: .3rem 0 .8rem;
      color: #8ab4f8;
    }
    ul {
      padding: 0;
      list-style: none;
      margin: 0;
      max-width: 100%;
    }
    .branch {
      background: #383a3c;
      border: 1px solid #555;
      border-radius: 6px;
      padding: .9rem;
      margin-top: .8rem;
    }
    .branch strong {
      color: #ff6b6b;
      font-size: 1.1rem;
    }
    .branch p {
      margin: .25rem 0;
      font-size: .95rem;
    }

    /* ---------- 4. 響應式 ---------- */
    @media(max-width:860px) {
      #wrap {
        flex-direction: column;
      }
      #mapBox {
        min-width: auto;
        height: 60vh;  /* 地圖上限 60% 視窗高，避免壓到下方 */
      }
      #sideBox {
        max-width: none;
        min-width: auto;
        border-left: none;
        border-top: 1px solid #444;
      }
    }
  </style>
</head>
<body>
  <div id="wrap">
    <!-- 地圖 -->
    <div id="mapBox">
      <h1 id="mapTitle">
        臺灣念佛會據點互動地圖
        <small id="version">v0.03</small>
      </h1>
      <div id="mapArea">
        <svg id="svgMap"></svg>
      </div>
    </div>

    <!-- 資訊欄 -->
    <aside id="sideBox">
      <h2>請點擊縣市</h2>
      <p>綠色代表已有念佛會據點。</p>
    </aside>
  </div>

  <!-- ---------- 4. 內嵌縣市 GeoJSON（離線可用） ---------- -->
  <script type="application/json" id="twCountyGeo">
    { … 你那超長的 JSON … }
  </script>

  <!-- -------- 主程式：畫地圖 -------- -->
  <script>
    // 每次更新時請同步修改這裡的版本號
    const VERSION = 'v0.04';

    document.addEventListener('DOMContentLoaded', ()=> {
      // 顯示版本
      document.getElementById('version').innerText = VERSION;

      /* ---------- 1. 念佛會據點 ---------- */
      const branches = [
        { county:"臺北市", township:"中正區", name:"淨土宗總部", tel:"02‑87894818", addr:"臺北市信義路五段150巷22弄41號" },
        { county:"臺北市", township:"松山區", name:"松山念佛會", tel:"02‑27471848", addr:"臺北市松山區八德路四段361巷1號B1" },
        { county:"新北市", township:"三重區", name:"三重分會", tel:"02‑29872157", addr:"新北市三重區中正北路17號3F" },
        { county:"新北市", township:"林口區", name:"林口念佛會", tel:"02‑26030710", addr:"新北市林口區仁愛路一段336之1號B1" },
        { county:"新北市", township:"板橋區", name:"板橋分會", tel:"02‑29524818", addr:"新北市板橋區四川路一段97號B1" },
        { county:"新北市", township:"深坑區", name:"深坑念佛會", tel:"02‑26222166", addr:"新北市深坑區北深路二段14號之2" },
        { county:"桃園市", township:"桃園區", name:"桃園念佛會", tel:"03‑3314818",  addr:"桃園市桃園區力行路5號6樓之一" },
        { county:"新竹市", township:"東區",   name:"新竹念佛會", tel:"03‑5367790",  addr:"新竹市東寧街108巷1弄1號" },
        { county:"苗栗縣", township:"苗栗市", name:"苗栗念佛會", tel:"0921‑961993", addr:"苗栗市站前一號10樓之5" },
        { county:"臺中市", township:"西區",   name:"臺中念佛會", tel:"04‑22225758", addr:"臺中市西區五權路2‑3號12樓" },
        { county:"臺中市", township:"清水區", name:"清水念佛會", tel:"04‑25327117", addr:"臺中市清水區中山路二段135號12樓" },
        { county:"南投縣", township:"竹山鎮", name:"竹山念佛會", tel:"049‑2654818", addr:"南投縣竹山鎮大仁路208號" },
        { county:"雲林縣", township:"虎尾鎮", name:"雲林虎尾念佛會", tel:"05‑5373070", addr:"雲林縣斗六市五權街89號" },
        { county:"嘉義市", township:"西區",   name:"嘉義民生分會", tel:"05‑2840118", addr:"嘉義市西區民生南路300號" },
        { county:"金門縣", township:"金寧鄉", name:"金門念佛會", tel:"0983‑391016", addr:"金門縣金寧鄉古寧頭山45號" },
        { county:"臺南市", township:"新營區", name:"新營念佛會", tel:"06‑6332232", addr:"臺南市新營區長榮路一段539號" },
        { county:"臺南市", township:"永康區", name:"永慶念佛會", tel:"06‑2315218", addr:"臺南市永康區永中街60巷10號" },
        { county:"高雄市", township:"美濃區", name:"永明寺",       tel:"07‑6832931", addr:"高雄市美濃區中正東路三段595號" },
        { county:"高雄市", township:"三民區", name:"高雄道場",     tel:"07‑3980806", addr:"高雄市三民區建國三路94號1樓" },
        { county:"屏東縣", township:"屏東市", name:"善導寺",       tel:"08‑7230038", addr:"屏東市民族路26號" }
      ];
      const hasBranch = {};
      branches.forEach(b => hasBranch[b.county] = true);

      /* ---------- 2. 畫地圖 ---------- */
      const svg = d3.select("#svgMap");
      let path, proj, active = null;

      function resize(){
        const box = document.getElementById("mapArea");
        const w   = box.clientWidth;
        const h   = box.clientHeight;

        svg.attr("width", w).attr("height", h).selectAll("*").remove();

        proj = d3.geoMercator()
                 .center([121,24])
                 .scale(w * 4)
                 .translate([w/2, h/2]);

        path = d3.geoPath().projection(proj);

        svg.selectAll("path")
           .data(JSON.parse(document.getElementById("twCountyGeo").textContent).features)
           .enter().append("path")
             .attr("d", path)
             .attr("class", d =>
               "county " +
               (hasBranch[d.properties.county || d.properties.COUNTYNAME]
                 ? "hasBranch"
                 : "defaultFill")
             )
             .on("click", (e,d) =>
               activate(d.properties.county || d.properties.COUNTYNAME, e.currentTarget)
             )
             .on("mouseover", function(){
               this.parentNode.appendChild(this);
             });
      }

      /* 點擊後更新右側清單 */
      function activate(county, node){
        if(active) active.classList.remove("active");
        node.classList.add("active");
        active = node;

        const list = branches.filter(b => b.county === county);
        const box  = document.getElementById("sideBox");

        if(!list.length){
          box.innerHTML = `<h2>${county}</h2><p>此縣市暫無念佛會據點。</p>`;
          return;
        }

        box.innerHTML = `<h2>${county}（${list.length}處）</h2><ul>` +
          list.map(b => `
            <li class="branch">
              <strong>${b.name}</strong>
              <p>鄉鎮：${b.township}</p>
              <p>地址：${b.addr}</p>
              <p>電話：<a href="tel:${b.tel}">${b.tel}</a></p>
            </li>
          `).join("") +
        `</ul>`;
      }

      /* ---------- 3. 初始化 ---------- */
      resize();                             // 首次繪圖
      window.addEventListener("resize", resize);

      /* 如要啟用捏合／滾輪縮放，請解除下面註解：*/
      const zoom = d3.zoom()
                     .scaleExtent([1,8])
                     .on("zoom", e => {
                       svg.selectAll('path').attr('transform', e.transform);
                     });
      svg.call(zoom);

    });
  </script>
</body>
</html>
