<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>臺灣念佛會據點互動地圖</title>
  <!-- D3 -->
  <script src="https://cdn.jsdelivr.net/npm/d3@7.9.0/dist/d3.min.js"></script>

  <style>
    html, body {
      margin: 0;
      height: 100%;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      background: #1d1f21;
      color: #eaeaea;
    }
    #wrap {
      display: flex;
      height: 100%;
    }
    /* 資訊區在左（桌面）、上（手機） */
    #mapBox { order: 2; }
    #sideBox { order: 1; }

    /* 地圖區 */
    #mapBox {
      flex: 3;
      min-width: 420px;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    #mapTitle {
      color: #8ab4f8;
      text-align: center;
      margin: .75rem 0 .25rem;
      font-size: 1.6rem;
    }
    #mapTitle small {
      font-size: 0.8rem;
      margin-left: 0.5rem;
      color: #aaa;
    }
    #mapArea {
      flex: 1;
      position: relative;
    }
    svg {
      width: 100%;
      height: 100%;
    }
    .county {
      stroke: #000;
      stroke-width: .6;
      cursor: pointer;
      transition: fill .15s;
    }
    .defaultFill { fill: #444; }
    .hasBranch { fill: #50bf7f; }
    .county:hover { fill: #f5a623; }
    .active { fill: #d0021b !important; }

    /* 資訊區 */
    #sideBox {
      flex: 2;
      min-width: 300px;
      max-width: 420px;
      background: #2d2f31;
      border-left: 1px solid #444;
      overflow-y: auto;
      padding: 1.25rem;
      box-sizing: border-box;
    }
    h2 {
      margin: .3rem 0 .8rem;
      color: #8ab4f8;
    }
    ul { padding: 0; list-style: none; margin: 0; }
    .branch {
      background: #383a3c;
      border: 1px solid #555;
      border-radius: 6px;
      padding: .9rem;
      margin-top: .8rem;
    }
    .branch strong { color: #ff6b6b; font-size: 1.1rem; }
    .branch p { margin: .25rem 0; font-size: .95rem; }

    @media(max-width:860px) {
      #wrap { flex-direction: column; }
      #mapBox {
        order: 2;
        min-width: auto;
        height: 60vh;
      }
      #sideBox {
        order: 1;
        max-width: none;
        min-width: auto;
        border-left: none;
        border-top: 1px solid #444;
      }
    }
  </style>
</head>
<body>
  <div id="wrap">
    <aside id="sideBox">
      <h2>請點擊縣市</h2>
      <p>綠色代表已有念佛會據點。</p>
    </aside>
    <div id="mapBox">
      <h1 id="mapTitle">
        臺灣念佛會據點互動地圖
        <small id="version">v0.08</small>
      </h1>
      <div id="mapArea">
        <svg id="svgMap"></svg>
      </div>
    </div>
  </div>

  <!-- ① 這裡貼上完整的 GeoJSON (你的 FeatureCollection) -->
  <script type="application/json" id="twCountyGeo">
{
  "type":"FeatureCollection",
  "link":"https://github.com/ronnywang/twgeojson",
  "data_time":"2011",
  "data_source":"http://segis.moi.gov.tw/STAT/Web/Platform/Product/STAT_ProductFreeList.aspx",
  "description":"100年全國縣市界圖",
  "features":[
    /* …你的各縣市 geometry features… */
  ]
}
  </script>

  <!-- ② 這裡貼上「據點資訊」JSON，腳本中會讀取 branches 陣列 -->
  <script type="application/json" id="branchData">
{
  "branches": [
    {
      "county_id": "10014",
      "name": "臺東念佛會",
      "address": "臺東縣臺東市和平路1號",
      "tel": "089-123456",
      "coords": [121.60160814722, 21.952645308679]
    },
    {
      "county_id": "10007",
      "name": "彰化念佛會",
      "address": "彰化縣彰化市中山路2段2號",
      "tel": "04-2345678",
      "coords": [120.48588603667, 24.197375739571]
    }
    /* …依此填入所有據點… */
  ]
}
  </script>

  <!-- 主程式：初始化地圖、設定縮放與拖移限制、繪製縣市與據點 -->
  <script>
    const width  = document.getElementById('mapArea').clientWidth;
    const height = document.getElementById('mapArea').clientHeight;
    const geoData    = JSON.parse(document.getElementById('twCountyGeo').textContent);
    const branchData = JSON.parse(document.getElementById('branchData').textContent);

    const projection = d3.geoMercator()
      .center([121, 24])
      .scale( width * 8 )
      .translate([ width/2, height/2 ]);

    const path = d3.geoPath().projection(projection);

    const svg = d3.select('#svgMap')
      .call(d3.zoom()
        .scaleExtent([1, 8])
        .translateExtent([[0, 0], [width, height]])
        .on('zoom', ({transform}) => svg.attr('transform', transform)))
      .append('g');

    // 畫縣市邊界
    svg.selectAll('path')
      .data(geoData.features)
      .enter().append('path')
      .attr('class', d =>
        branchData.branches.some(b => b.county_id === d.properties.county_id)
          ? 'county hasBranch'
          : 'county defaultFill'
      )
      .attr('d', path)
      .on('click', (event, d) => {
        // 樣式切換
        svg.selectAll('.county').classed('active', false);
        d3.select(event.currentTarget).classed('active', true);
        // 列表顯示
        const list = branchData.branches.filter(b => b.county_id === d.properties.county_id);
        const side = d3.select('#sideBox');
        side.html(`
          <h2>${d.properties.county}</h2>
          <ul>
            ${list.map(b => `
              <li class="branch">
                <strong>${b.name}</strong>
                <p>${b.address}</p>
                <p>Tel: ${b.tel}</p>
              </li>
            `).join('')}
          </ul>
        `);
      });

    // 在地圖上畫據點圓點
    svg.selectAll('circle')
      .data(branchData.branches)
      .enter().append('circle')
      .attr('cx', d => projection(d.coords)[0])
      .attr('cy', d => projection(d.coords)[1])
      .attr('r', 4)
      .attr('fill', '#ff6b6b')
      .attr('stroke', '#fff')
      .attr('stroke-width', 1);
  </script>
</body>
</html>
